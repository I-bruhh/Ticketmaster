<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='concerts.css') }}">
</head>
<body>
<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="{{ url_for('concert.concerts') }}">Concerts</a></li>
    <li><a href="{{ url_for('profile.view_profile') }}">Profile</a></li>
    <!-- Add the following line for the logout link -->
    <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
  </ul>
</nav>

    <div class="content">
        <h1>Waiting Room</h1>

        <div class="content">
            <p>You are in the waiting room. Please wait for your turn to purchase tickets.</p>
            <p id="position-info">Your current cluster number: <span id="position">{{ cluster_number }}</span></p>
        </div>

        <h1>Concert Details</h1>
        <table>
            <!-- Your concert details table here -->
        </table>
    </div>

    <script>
        function checkWaitingRoom() {
            setInterval(function () {
                // Perform AJAX request to check user's position and turn
                fetch("http://127.0.0.1:5001/concert/{{ concert.concert_id }}/user_status", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        // You may need to include additional headers based on your server requirements
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Update UI based on server response
                    if (data.clusterNumber !== null) {
                        document.getElementById("position").innerText = "Your cluster number: " + data.clusterNumber;

                        // Check conditions for redirection
                        if (data.isUserTurn && data.saleStarted) {
                            //  Check the user is in the front cluster
                            if (data.clusterNumber === 0) {
                                // Redirect to the booth page
                                window.location.href = "http://127.0.0.1:5001/concert/{{ concert.concert_id }}/enter_booth";
                            } else {
                                // Refresh the page every 30 seconds
                                setTimeout(() => location.reload(), 10000);
                            }
                        }
                    } else {
                        // Handle the case where clusterNumber is null (display a message or set a default value)
                        document.getElementById("position").innerText = "Your cluster number: N/A";
                    }
                })
                .catch(error => console.error("Error:", error));
            }, 4000); // Check every 4 seconds
        }

        // Call the function to check the waiting room when the page loads
        window.onload = checkWaitingRoom;
    </script>
</body>
</html>
