<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='concerts.css') }}">
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="{{ url_for('concert.concerts') }}">Concerts</a></li>
            <li><a href="{{ url_for('profile.view_profile') }}">Profile</a></li>
        </ul>
    </nav>

    <div class="content">
        <h1>Waiting Room</h1>

        <div class="content">
            <p>You are in the waiting room. Please wait for your turn to purchase tickets.</p>
            <p id="position-info">Your current position in the queue: <span id="position">{{ queue_position }}</span></p>
        </div>

        <h1>Concert Details</h1>
        <table>
            <!-- Your concert details table here -->
        </table>
    </div>

    <script>
        function checkWaitingRoom() {
            setInterval(function () {
                // Perform AJAX request to check user's position and turn
                fetch("http://127.0.0.1:5001/concert/{{ concert.concert_id }}/user_status", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        // You may need to include additional headers based on your server requirements
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Update UI based on server response
                    if (data.queuePosition !== null) {
                        document.getElementById("position").innerText = "Your position: " + data.queuePosition;

                        // Check conditions for redirection
                        if (data.isUserTurn && data.saleStarted) {
                            // Check if the booth has 1 to 3 slots, and the user is in front of the queue
                            if (data.boothSlots > 0 && data.boothSlots <= 3 && data.queuePosition === 0) {
                                // Redirect to the booth page
                                window.location.href = "http://127.0.0.1:5000/concert/concert.concert_id/booth";
                            } else {
                                // Refresh the page every 30 seconds
                                setTimeout(() => location.reload(), 10000);
                            }
                        }
                    } else {
                        // Handle the case where queuePosition is null (display a message or set a default value)
                        document.getElementById("position").innerText = "Your position: N/A";
                    }
                })
                .catch(error => console.error("Error:", error));
            }, 5000); // Check every 5 seconds
        }

        // Call the function to check the waiting room when the page loads
        window.onload = checkWaitingRoom;
    </script>
</body>
</html>
